{% extends "base.html" %}
{% block title %}å‡ºæ¬ ç¢ºèª{% endblock %}

{% block content %}
<h2>å‡ºæ¬ ç¢ºèª</h2>

<!-- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="alert alert-success">
      {% for msg in messages %}
        <div>{{ msg }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<!-- å‡ºåŠ›ãƒœã‚¿ãƒ³ -->
{% if selected_date and selected_event %}
  <a href="{{ url_for('export_attendance_csv', date=selected_date, event=selected_event, team=request.args.getlist('team')) }}" class="btn btn-success mb-3">
    ğŸ“¥ CSVå‡ºåŠ›
  </a>
  <a href="{{ url_for('export_attendance_pdf', date=selected_date, event=selected_event, team=request.args.getlist('team')) }}" class="btn btn-danger mb-3">
    ğŸ–¨ PDFå‡ºåŠ›
  </a>
{% endif %}

<form action="{{ url_for('delete_attendance_event') }}" method="POST" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">
  <input type="hidden" name="date" value="{{ selected_date }}">
  <input type="hidden" name="event" value="{{ selected_event }}">
  <button type="submit" class="btn btn-danger">ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤</button>
</form>

<!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ  -->
<form method="GET" class="mb-4" id="filterForm">
  <div class="row g-2 align-items-end">
    
    <!-- ãƒãƒ¼ãƒ å -->
    <div class="col-md-2">
      <label>ãƒãƒ¼ãƒ å</label>
      <select name="team" class="form-select" multiple onchange="document.getElementById('filterForm').submit()" style="min-width: 160px;">
        {% for t in teams %}
          <option value="{{ t }}" {% if t in selected_teams %}selected{% endif %}>{{ t }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- æ—¥ä»˜ã¨ã‚¤ãƒ™ãƒ³ãƒˆåï¼ˆç¸¦ä¸¦ã³ï¼‰ -->
    <div class="col-md-2">
      <div class="mb-2">
        <label>æ—¥ä»˜</label>
        <select name="date" class="form-select" onchange="document.getElementById('filterForm').submit()">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          {% for d, e in events %}
            <option value="{{ d }}" {% if d == selected_date %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>ã‚¤ãƒ™ãƒ³ãƒˆå</label>
        <select name="event" class="form-select" onchange="document.getElementById('filterForm').submit()">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          {% for d, e in events %}
            {% if d == selected_date %}
              <option value="{{ e }}" {% if e == selected_event %}selected{% endif %}>{{ e }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- å‡ºèº«æ ¡ -->
    <div class="col-md-2">
      <label>å‡ºèº«æ ¡</label>
      <select name="school" class="form-select" multiple>
        {% for s in schools %}
          <option value="{{ s[0] }}" {% if s[0] in request.args.getlist('school') %}selected{% endif %}>{{ s[0] }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- å­¦å¹´ -->
    <div class="col-md-2">
      <label>å­¦å¹´</label>
      <select name="grade" class="form-select" multiple>
        {% for g in grades %}
          <option value="{{ g[0] }}" {% if g[0]|string in request.args.getlist('grade') %}selected{% endif %}>{{ g[0] }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- æ€§åˆ¥ -->
    <div class="col-md-2">
      <label>æ€§åˆ¥</label>
      <select name="gender" class="form-select" multiple>
        {% for gender in genders %}
          <option value="{{ gender[0] }}" {% if gender[0] in request.args.getlist('gender') %}selected{% endif %}>{{ gender[0] }}</option>
        {% endfor %}
      </select>
    </div>

  </div>
  <button type="submit" class="btn btn-primary mt-3">è¡¨ç¤º</button>
</form>


<!-- å‡ºæ¬ å…¥åŠ›ãƒ†ãƒ¼ãƒ–ãƒ« -->
{% if records %}
<form method="POST">
  <table class="table table-bordered align-middle">
    <thead>
      <tr>
        <th>åå‰</th>
        <th>å­¦å¹´</th>
        <th>æ€§åˆ¥</th>
        <th>å‡ºèº«æ ¡</th>
        <th>å‡ºå¸­</th>
      </tr>
    </thead>
    <tbody>
      {% for record in records %}
        <tr>
          <td>{{ record.profile.name }}</td>
          <td>{{ record.profile.grade }}</td>
          <td>{{ record.profile.gender }}</td>
          <td>{{ record.profile.school }}</td>
          <td>
            <select name="status_{{ record.profile.id }}" class="form-select">
              <option value="">---</option>
              <option value="å‡ºå¸­" {% if record.status == "å‡ºå¸­" %}selected{% endif %}>å‡ºå¸­</option>
              <option value="æ¬ å¸­" {% if record.status == "æ¬ å¸­" %}selected{% endif %}>æ¬ å¸­</option>
              <option value="é…åˆ»" {% if record.status == "é…åˆ»" %}selected{% endif %}>é…åˆ»</option>
              <option value="æ—©é€€" {% if record.status == "æ—©é€€" %}selected{% endif %}>æ—©é€€</option>
            </select>
          </td>
          <td>
            <input type="text" name="memo_{{ record.profile.id }}" value="{{ record.memo or '' }}" placeholder="ãƒ¡ãƒ¢" style="width: 100%;">
        ã€€</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  <button type="submit" class="btn btn-success">ä¿å­˜</button>
</form>
{% else %}
  <p class="text-muted">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
{% endif %}

{% endblock %}